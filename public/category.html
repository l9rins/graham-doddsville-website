<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Graham and Doddsville - Financial News Archive">
    <meta name="keywords" content="value investing, financial news, market analysis">
    <meta name="author" content="Graham and Doddsville Pty Ltd">
    <meta name="robots" content="index, follow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title id="page-title">Graham and Doddsville - News Archive</title>
    <link rel="stylesheet" href="/css/styles.css?v=5.7&t=20241224">

    <!-- Performance Optimizations -->
    <link rel="preconnect" href="https://images.unsplash.com">
    <link rel="preconnect" href="https://img.youtube.com">
    <link rel="dns-prefetch" href="https://www.skynews.com.au">
</head>
<body>
    <!-- Header -->
    <header style="background-color: #1e3a8a; color: white; padding: 20px 0; margin-bottom: 30px;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <a href="index.html" style="color: white; text-decoration: none; font-size: 14px; font-weight: 500;">
                        ‚Üê Back to Home
                    </a>
                </div>
                <div>
                    <h1 id="category-title" style="margin: 0; font-size: 24px; font-weight: 600;">News Archive</h1>
                </div>
                <div style="width: 100px;"></div> <!-- Spacer for centering -->
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main style="max-width: 800px; margin: 0 auto; padding: 0 20px;">
        <!-- Loading Indicator -->
        <div id="loading-indicator" style="text-align: center; padding: 40px; color: #666;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #1e3a8a; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;"></div>
            <div>Loading articles...</div>
        </div>

        <!-- News Container -->
        <div id="category-news-container" style="display: none;">
            <!-- Articles will be injected here -->
        </div>

        <!-- No Articles Message -->
        <div id="no-articles" style="display: none; text-align: center; padding: 40px; color: #999; font-style: italic;">
            No articles found for this category.
        </div>
    </main>

    <!-- CSS Animation for Loading Spinner -->
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Clean newspaper styling for articles */
        .archive-news-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .archive-news-item:last-child {
            border-bottom: none;
        }

        .archive-news-item a {
            font-family: Georgia, serif;
            font-size: 16px;
            font-weight: 600;
            color: #111;
            text-decoration: none;
            line-height: 1.4;
        }

        .archive-news-item a:hover {
            color: #1e3a8a;
        }

        .archive-news-meta {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }

        .archive-news-source {
            text-transform: uppercase;
            font-weight: bold;
            color: #1e3a8a;
        }
    </style>

    <!-- News Archive Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const categoryType = urlParams.get('type');

        // Redirect to home if no type parameter
        if (!categoryType) {
            window.location.href = 'index.html';
            return;
        }

        // Set page title and category title
        const categoryTitles = {
            'regulatory': 'Regulatory News Archive',
            'guru-watch': 'Guru Watch Archive',
            'economy': 'Economy News Archive',
            'companies': 'Company News Archive',
            'markets': 'Markets News Archive',
            'commodities': 'Commodities News Archive',
            'industry': 'Industry News Archive',
            'north-america': 'North America News Archive',
            'europe': 'Europe News Archive',
            'asia': 'Asia News Archive',
            'elsewhere': 'Global News Archive'
        };

        const title = categoryTitles[categoryType] || 'News Archive';
        document.getElementById('page-title').textContent = `Graham and Doddsville - ${title}`;
        document.getElementById('category-title').textContent = title;

        // Start fetching news for this category
        fetchCategoryNews(categoryType);
    });

    async function fetchCategoryNews(categoryType) {
        console.log(`üöÄ Loading ${categoryType} archive...`);

        const feedConfig = [
            { id: 'yahoo', url: 'https://finance.yahoo.com/news/rssindex', name: 'Yahoo Finance' },
            { id: 'mining', url: 'https://www.mining.com/feed/', name: 'Mining.com' },
            { id: 'regulatory', url: 'https://news.google.com/rss/search?q=ASIC+investigation+OR+ACCC+fine+OR+APRA+regulation+Australia&hl=en-AU&gl=AU&ceid=AU:en', name: 'Regulator Watch' },
            { id: 'guru', url: 'https://news.google.com/rss/search?q=Warren+Buffett+OR+Charlie+Munger+OR+Ray+Dalio+investing&hl=en-US&gl=US&ceid=US:en', name: 'Guru Watch' },
            { id: 'economy_backup', url: 'https://news.google.com/rss/search?q=Reserve+Bank+of+Australia+Interest+Rates+Inflation+Economy&hl=en-AU&gl=AU&ceid=AU:en', name: 'RBA News' },
            { id: 'north_america', url: 'https://news.google.com/rss/search?q=US+Stock+Market+Economy+Fed&hl=en-US&gl=US&ceid=US:en', name: 'US Markets' },
            { id: 'europe', url: 'https://news.google.com/rss/search?q=ECB+European+Markets+Economy&hl=en-GB&gl=GB&ceid=GB:en', name: 'Euro Markets' },
            { id: 'asia', url: 'https://news.google.com/rss/search?q=China+Economy+Japan+Markets+ASX&hl=en-SG&gl=SG&ceid=SG:en', name: 'Asian Markets' },
            { id: 'elsewhere', url: 'https://news.google.com/rss/search?q=Global+Economy+Emerging+Markets&hl=en-AU&gl=AU&ceid=AU:en', name: 'Global News' }
        ];

        let allArticles = [];

        const promises = feedConfig.map(async (feed) => {
            try {
                const cacheBuster = `&_t=${new Date().getTime()}`;
                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}${cacheBuster}`);
                const data = await res.json();
                if (data.status === 'ok') {
                    return data.items.map(item => ({
                        title: item.title,
                        link: item.link,
                        pubDate: item.pubDate,
                        description: (item.description || '').replace(/<[^>]*>?/gm, ''),
                        sourceId: feed.id,
                        displaySource: feed.name
                    }));
                }
            } catch (err) {
                console.warn(`Skipping ${feed.name}:`, err);
            }
            return [];
        });

        const results = await Promise.all(promises);
        results.forEach(items => allArticles.push(...items));

        updateCategoryDisplay(allArticles, categoryType);
    }

    function updateCategoryDisplay(articles, categoryType) {
        // Filter articles based on category
        const cleanArticles = articles.filter(article => {
            const t = article.title.toLowerCase();
            const badWords = ['stabbing', 'murder', 'police', 'arrest', 'dead', 'die', 'killed', 'court', 'jail', 'crash', 'tennis', 'cricket', 'rugby', 'lottery'];
            if (article.sourceId === 'regulatory' && t.includes('court')) return true;
            return !badWords.some(w => t.includes(w));
        });

        // Category mapping (same as main page)
        const commodityKeywords = /gold|silver|lithium|copper|oil|gas|nickel|iron ore|mineral|metal/i;

        const categoryFilters = {
            'regulatory': a => a.sourceId === 'regulatory',
            'guru-watch': a => a.sourceId === 'guru',
            'commodities': a => a.sourceId === 'mining' || a.title.match(commodityKeywords),
            'economy': a => a.sourceId === 'economy_backup',
            'companies': a => a.sourceId === 'yahoo' && a.title.match(/profit|revenue|shares|dividend|earnings/i),
            'markets': a => a.sourceId === 'yahoo' && !a.title.match(/profit|revenue/i),
            'industry': a => a.sourceId === 'mining' && !a.title.match(commodityKeywords),
            'north-america': a => a.sourceId === 'north_america',
            'europe': a => a.sourceId === 'europe',
            'asia': a => a.sourceId === 'asia',
            'elsewhere': a => a.sourceId === 'elsewhere'
        };

        // Filter articles for this category and show all available (no 5-article limit)
        const categoryArticles = cleanArticles.filter(categoryFilters[categoryType] || (() => false));

        // Hide loading indicator
        document.getElementById('loading-indicator').style.display = 'none';

        const container = document.getElementById('category-news-container');
        const noArticles = document.getElementById('no-articles');

        if (categoryArticles.length === 0) {
            noArticles.style.display = 'block';
            return;
        }

        // Show all available articles (no limit like main page)
        const html = categoryArticles.map(a => `
            <div class="archive-news-item">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div style="flex:1;">
                        <a href="${a.link}" target="_blank" class="archive-news-link">${a.title}</a>
                        <div class="archive-news-meta">
                            <span class="archive-news-source">${a.displaySource}</span>
                            ‚Ä¢ ${formatDate(a.pubDate)}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');

        container.innerHTML = html;
        container.style.display = 'block';

        console.log(`‚úÖ Loaded ${categoryArticles.length} articles for ${categoryType} archive`);
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const diff = Math.floor((new Date() - new Date(dateString)) / 1000);
        if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
        return Math.floor(diff / 86400) + 'd ago';
    }
    </script>
</body>
</html>